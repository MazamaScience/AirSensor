<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Purple Air Quality Control • AirSensor</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Purple Air Quality Control">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">AirSensor</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.18</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/AirSensorOverview.html">AirSensor Function Overview</a>
    </li>
    <li>
      <a href="../articles/SoH_functions.html">SoH Functions</a>
    </li>
    <li>
      <a href="../articles/articles/DataFlowChart.html">Processing PurpleAir Data</a>
    </li>
    <li>
      <a href="../articles/outlier_detection.html">Outlier Detection with the Hampel Filter</a>
    </li>
    <li>
      <a href="../articles/pas_introduction.html">An Introduction to PurpleAir Synoptic Data</a>
    </li>
    <li>
      <a href="../articles/pat_introduction.html">An Introduction to PurpleAir TimeSeries Data</a>
    </li>
    <li>
      <a href="../articles/purpleair_failure_modes.html">PurpleAir Failure Modes</a>
    </li>
    <li>
      <a href="../articles/purpleair_qc.html">Purple Air Quality Control</a>
    </li>
    <li>
      <a href="../articles/purpleair_sensors.html">Purple Air Sensors</a>
    </li>
    <li>
      <a href="../articles/working_with_wind_data.html">Working With Wind Data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/AirSensor">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Purple Air Quality Control</h1>
                        <h4 class="author">Mazama Science</h4>
            
            <h4 class="date">2019-07-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/AirSensor/blob/master/vignettes/purpleair_qc.Rmd"><code>vignettes/purpleair_qc.Rmd</code></a></small>
      <div class="hidden name"><code>purpleair_qc.Rmd</code></div>

    </div>

    
    
<p>This vignette decribes Quality Control (QC) functions and best practices for working with Purple Air Sensor data.</p>
<div id="raw-engineering-data" class="section level2">
<h2 class="hasAnchor">
<a href="#raw-engineering-data" class="anchor"></a>Raw “Engineering” Data</h2>
<p>The <strong>AirSensor</strong> package <em>pat</em> data model and associated functions make it easy to work with raw Purple Air data. (<em>pat</em> is for <em>P</em>urple <em>A</em>ir <em>T</em>imeseries.) Each <em>pat</em> object provides unmodified data obtained from the <em>ThingSpeak</em> database. (ThingSpeak is the Internet of Things data provider that Purple Air has partnered with to handle access to archival data.)</p>
<p>See the pat_introduction vignette for details.</p>
<div id="good-data" class="section level3">
<h3 class="hasAnchor">
<a href="#good-data" class="anchor"></a>Good Data</h3>
<p>Lets begin by looking at one week’s worth of trouble free sensor data:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">pat &lt;-<span class="st"> </span>example_pat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/pat_filterDate.html">pat_filterDate</a></span>(<span class="dv">20180701</span>, <span class="dv">20180708</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co"># use sampleSize = NULL to force display of every data point</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="../reference/pat_multiplot.html">pat_multiplot</a></span>(pat, <span class="dt">sampleSize =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="purpleair_qc_files/figure-html/example_pat_basic-1.png" width="672"></p>
<p>In this case, no obvious errors are seen in the data.</p>
</div>
<div id="bad-humitidy-values-noisy-channel-a" class="section level3">
<h3 class="hasAnchor">
<a href="#bad-humitidy-values-noisy-channel-a" class="anchor"></a>Bad Humitidy Values, Noisy Channel A</h3>
<p>Occasionally one sees aphysical relative humidity values &gt; 100. The example below also shows one of the particle detectors generating noisy data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"example_pat_failure_A"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">pat &lt;-<span class="st"> </span>example_pat_failure_A</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co"># use sampleSize = NULL to force display of every data point</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw"><a href="../reference/pat_multiplot.html">pat_multiplot</a></span>(pat, <span class="dt">sampleSize =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="purpleair_qc_files/figure-html/example_pat_failure_A_basic-1.png" width="672"></p>
</div>
<div id="out-of-spec-pm2-5-values" class="section level3">
<h3 class="hasAnchor">
<a href="#out-of-spec-pm2-5-values" class="anchor"></a>Out-of-spec PM2.5 Values</h3>
<p>One of the PM2.5 channels can also report completely bogus data:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"example_pat_failure_B"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">pat &lt;-<span class="st"> </span>example_pat_failure_B</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co"># use sampleSize = NULL to force display of every data point</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw"><a href="../reference/pat_multiplot.html">pat_multiplot</a></span>(pat, <span class="dt">sampleSize =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="purpleair_qc_files/figure-html/example_pat_failure_B_basic-1.png" width="672"></p>
</div>
</div>
<div id="raw-data-qc" class="section level2">
<h2 class="hasAnchor">
<a href="#raw-data-qc" class="anchor"></a>Raw Data QC</h2>
<p>The examples above demonstrate just two of many possible failure modes but they provide data we can use to develop basic QC algorithms that identify the most egregiously misbehaving data without throwing away potentially interesting outliers.</p>
<p>The least controversial QC is the removal of values that are out-of-spec for the sensor. Purple Air provides <a href="https://www2.purpleair.com/products/purpleair-pa-ii">PA-II sensor specs</a> which define the valid measurement range for each variable:</p>
<pre><code>  0 &lt;   humidity  &lt; 100
-40 &lt; temperature &lt; 185
  0 &lt;     pm25    &lt; 1000</code></pre>
<p>The <code><a href="../reference/pat_qc.html">pat_qc()</a></code> function applies these thresholds and returns a <em>pat</em> object where out-of-spec values have been replaced by <code>NA</code>. See how the out-of-spec humidity values get replaced in <code>example_pat_failure_A</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">pat &lt;-</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span>example_pat_failure_A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/pat_qc.html">pat_qc</a></span>()</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="kw"><a href="../reference/pat_multiplot.html">pat_multiplot</a></span>(pat, <span class="dt">sampleSize =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="purpleair_qc_files/figure-html/example_pat_failure_A_qc1-1.png" width="672"></p>
<p>The case of <code>example_pat_failure_B</code> is also improved by removing out-of-spec values but some questionable data still exist in channel A:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">pat &lt;-</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">  </span>example_pat_failure_B <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/pat_qc.html">pat_qc</a></span>()</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw"><a href="../reference/pat_multiplot.html">pat_multiplot</a></span>(pat, <span class="dt">sampleSize =</span> <span class="ot">NULL</span>)</a></code></pre></div>
<p><img src="purpleair_qc_files/figure-html/example_pat_failure_B_qc1-1.png" width="672"></p>
</div>
<div id="aggregation" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregation" class="anchor"></a>Aggregation</h2>
<p>The <code><a href="../reference/pat_aggregate.html">pat_aggregate()</a></code> function is used in the conversion of <em>pat</em> data objects into dataframes with a uniform, typically hourly, time axis. The aggregation process invovles creating regular time bins and then calculating a variety of statistics for the data within each bin. We end up with a dataframe with a regular time axis and multiple columns of statistics for each input variable.</p>
<p>Applying our uncontroversial <code><a href="../reference/pat_qc.html">pat_qc()</a></code> as the first step in the pipeline, we can reivew which statistics are calcualted:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">df &lt;-</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span>example_pat_failure_A <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/pat_qc.html">pat_qc</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/pat_aggregate.html">pat_aggregate</a></span>(<span class="dt">period =</span> <span class="st">"1 hour"</span>)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span>(df)</a></code></pre></div>
<pre><code>## [1] "data.frame"</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(df)</a></code></pre></div>
<pre><code>##  [1] "datetime"           "pm25_t"             "pm25_p"            
##  [4] "pm25_df"            "pm25_A_mean"        "pm25_B_mean"       
##  [7] "pm25_A_median"      "pm25_B_median"      "pm25_A_sd"         
## [10] "pm25_B_sd"          "pm25_A_min"         "pm25_B_min"        
## [13] "pm25_A_max"         "pm25_B_max"         "pm25_A_count"      
## [16] "pm25_B_count"       "humidity_mean"      "humidity_median"   
## [19] "humidity_sd"        "humidity_min"       "humidity_max"      
## [22] "humidity_count"     "temperature_mean"   "temperature_median"
## [25] "temperature_sd"     "temperature_min"    "temperature_max"   
## [28] "temperature_count"</code></pre>
<div id="aggregation-statistics" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregation-statistics" class="anchor"></a>Aggregation statistics</h3>
<p>For each variable, core statistics are calculated for the population of measurements found in each time bin:</p>
<ul>
<li>mean</li>
<li>median</li>
<li>sd – standard deviation</li>
<li>min</li>
<li>max</li>
<li>count</li>
</ul>
</div>
<div id="students-t-test" class="section level3">
<h3 class="hasAnchor">
<a href="#students-t-test" class="anchor"></a>Student’s t-Test</h3>
<p>Every Purple Air II sensor has two separate particle detectors, each reporting on a separate channel: A and B. When measurements in both channels agree within measurement error then we have higher confidence in the measurements. Because the two particle detectors are so close together we shouldn’t expect any difference in the air entering detector A or B.</p>
<p>The two-sample t-test is the standard statistical technique for determining whether a difference in two means is significant or can be attributed to random processes. The friendliest explanation of this statistical technique is available through a serires of <a href="https://www.khanacademy.org/math/ap-statistics/two-sample-inference#two-sample-t-test-means">Khan Academy videos</a></p>
<p>When the Purple Air sensor is functioning properly we expect the hourly average of A channel PM2.5 measurements to be close to the average of B channel PM2.5 measurements. To determine whether this NULL hypothesis holds, the <code><a href="../reference/pat_aggregate.html">pat_aggregate()</a></code> function does some additional work for PM2.5 and calculates the following addition two-sample t-test statistics:</p>
<ul>
<li>t – t-statistic</li>
<li>p – p-value</li>
<li>df – degrees of freedom for the t-statistic</li>
</ul>
<p>For visual thinkers, imagine a boxplot showing the range of values from the A and B channels for a particular hour. If the boxplots overlap, then the means, although not identical, are not significantly different.</p>
<p>A picture may help. Below we display hourly boxplots for the A and B channels during a day when they largely agree:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co"># Always specify a timezone wherever possible!</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">timezone &lt;-<span class="st"> "America/Los_Angeles"</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co"># Grab a 1-day subset of the data</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">raw_data &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="st">  </span>example_pat_failure_B <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="../reference/pat_filterDate.html">pat_filterDate</a></span>(<span class="dv">20190611</span>,<span class="dv">20190612</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="../reference/pat_extractDataFrame.html">pat_extractData</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(datetime, pm25_A, pm25_B) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="st">  </span><span class="co"># Convert datetime to an hourly timestamp to use as a factor</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">datetime =</span> <span class="kw"><a href="https://rdrr.io/r/base/strptime.html">strftime</a></span>(datetime, <span class="st">"%Y%m%d%H"</span>, <span class="dt">tz =</span> timezone)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="st">  </span><span class="co"># Convert from wide to "tidy" so we can use channel as a factor</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="st">"channel"</span>, <span class="st">"pm25"</span>, <span class="op">-</span>datetime)</a>
<a class="sourceLine" id="cb11-16" data-line-number="16"></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co"># Look at a random sample of this new dataframe</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18">dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample_n</a></span>(raw_data, <span class="dv">10</span>)</a></code></pre></div>
<pre><code>##      datetime channel  pm25
## 1  2019061115  pm25_A  7.74
## 2  2019061116  pm25_B  6.44
## 3  2019061116  pm25_A  8.55
## 4  2019061100  pm25_B  6.67
## 5  2019061101  pm25_A  6.54
## 6  2019061111  pm25_A  9.61
## 7  2019061110  pm25_B  7.29
## 8  2019061122  pm25_B 14.09
## 9  2019061102  pm25_A  5.14
## 10 2019061106  pm25_B  7.09</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># Create a timeseries using boxplots</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">colors &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span>(<span class="fl">0.9</span>, <span class="fl">0.25</span>, <span class="fl">0.2</span>), <span class="kw"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span>(<span class="fl">0.2</span>, <span class="fl">0.25</span>, <span class="fl">0.9</span>))</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(raw_data, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(datetime, pm25, <span class="dt">color =</span> channel)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span>(<span class="dt">outlier.shape =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">               <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="dt">values=</span>colors) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="dt">pch=</span><span class="dv">15</span>, <span class="dt">cex=</span><span class="fl">0.2</span>, <span class="dt">position =</span> <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html">position_jitterdodge</a></span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"A/B hourly averages"</span>)</a></code></pre></div>
<p><img src="purpleair_qc_files/figure-html/AB_boxplot-1.png" width="672"></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># Compare the t-statistic for that day</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">agg_data &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span>example_pat_failure_B <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/pat_filterDate.html">pat_filterDate</a></span>(<span class="dv">20190611</span>,<span class="dv">20190612</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/pat_aggregate.html">pat_aggregate</a></span>()</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(agg_data, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(datetime, pm25_p)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"t-test p-value"</span>)</a></code></pre></div>
<p><img src="purpleair_qc_files/figure-html/AB_boxplot-2.png" width="672"></p>
<p>And here is the same for a day with serious problems:</p>
<pre><code>##      datetime channel    pm25
## 1  2019061209  pm25_B   16.00
## 2  2019061212  pm25_B   17.51
## 3  2019061201  pm25_A   19.71
## 4  2019061214  pm25_A   16.17
## 5  2019061207  pm25_A 3327.66
## 6  2019061221  pm25_A 3331.37
## 7  2019061207  pm25_A 3330.56
## 8  2019061208  pm25_A 3330.26
## 9  2019061220  pm25_A      NA
## 10 2019061218  pm25_B   10.85</code></pre>
<p><img src="purpleair_qc_files/figure-html/AB_boxplot_2-1.png" width="672"><img src="purpleair_qc_files/figure-html/AB_boxplot_2-2.png" width="672"></p>
<p>We can see that the null hypothesis – the difference in means is entirely due to chance – is extremely unlikely <code>pm25_p &lt; 1e-30</code>, for example, only occur for hours where the A and B channels have hourly avergaes that are both highly precise (low std dev) and very different. We can thus use the <code>pm25_t</code> variable to flag those hours where the A and B channels disagree.</p>
</div>
</div>
<div id="hourly-averages" class="section level2">
<h2 class="hasAnchor">
<a href="#hourly-averages" class="anchor"></a>Hourly Averages</h2>
<p>One of the most important data products we can create form raw Purple Air data is the hourly avergaged dataset that can be used for comparison with co-located federal regulatory monitors.</p>
<p>The following steps are recommend for creating an hourly PM2.5 timeseries:</p>
<ol style="list-style-type: decimal">
<li>apply out-of-spec QC</li>
<li>calculate aggregation statistics</li>
<li>average together pm25_A and pm25_B hourly values</li>
<li>invalidate pm25 values where the count on either the A or B channel is below some threshold (e.g. 10 where 30 are expected)</li>
<li>invalidate pm25 hourly values then the mean difference is “moderate” or above (e.g. &gt; 10) AND the p-value is below some threshold (e.g. &lt; 1e-4)</li>
<li>invalidate pm25 hourly values regardless of p-value when the average pm25 value is below some threshold (e.g. &lt; 100) and the difference between channel A and B means is high (e.g. &gt; 20)</li>
</ol>
<pre><code>  (min_count &lt; 10)
  (p-value &lt; 1e-4) &amp; (mean_diff &gt; 10)
  (pm25 &lt; 100) &amp; (mean_diff &gt; 20)</code></pre>
<p>This combination of QC steps is used in when the <code><a href="../reference/pat_createAirSensor.html">pat_createAirSensor()</a></code> function is run with <code>qc_algorithm = "hourly_AB_01"</code>.</p>
<p>As a test of the overall effect, here are some simple, hourly barplots for a single week of data for each of the three examples we started with:</p>
<p><img src="purpleair_qc_files/figure-html/hourly_barplots-1.png" width="672"></p>
<p>Things look pretty good. The first two time seres look quite reasonable given the input data and <em>most</em> of the hours of questionable data have been removed from <code>example_pat_failure_B</code>. The only questionably high value in <code>example_pat_failure_B</code> has values on either side that have been flagged as invalid which should raise questions.</p>
<p>It is beyond the scope of this vignette, but one could imagine further cleanup that removed every value adjacent to an invalid value which would have completely cleaned up the last example.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#raw-engineering-data">Raw “Engineering” Data</a></li>
      <li><a href="#raw-data-qc">Raw Data QC</a></li>
      <li><a href="#aggregation">Aggregation</a></li>
      <li><a href="#hourly-averages">Hourly Averages</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan, Hans Martin, Kayleigh Wilson, Tate Brasel, Helen Miller.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
