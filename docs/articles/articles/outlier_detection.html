<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outlier Detection with the Hampel Filter • AirSensor</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Outlier Detection with the Hampel Filter">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">AirSensor</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/AirSensor_Function_Overview.html">AirSensor Function Overview</a>
    </li>
    <li>
      <a href="../../articles/Developer_Style_Guide.html">Developer Style Guide</a>
    </li>
    <li>
      <a href="../../articles/articles/Australia_on_fire.html">Australia on Fire</a>
    </li>
    <li>
      <a href="../../articles/articles/Custom_QC_Algorithms.html">Custom QC Algorithms</a>
    </li>
    <li>
      <a href="../../articles/articles/DataFlowChart.html">Processing PurpleAir Data</a>
    </li>
    <li>
      <a href="../../articles/articles/SoH_functions.html">SoH Functions</a>
    </li>
    <li>
      <a href="../../articles/articles/Temporal_Aggregation.html">Temporally Aggregated Time Series</a>
    </li>
    <li>
      <a href="../../articles/articles/outlier_detection.html">Outlier Detection with the Hampel Filter</a>
    </li>
    <li>
      <a href="../../articles/articles/pas_introduction.html">PurpleAir Synoptic Data</a>
    </li>
    <li>
      <a href="../../articles/articles/pat_introduction.html">PurpleAir TimeSeries Data</a>
    </li>
    <li>
      <a href="../../articles/articles/purpleair_failure_modes.html">PurpleAir Failure Modes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/AirSensor">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Outlier Detection with the Hampel Filter</h1>
                        <h4 class="author">Mazama Science</h4>
            
            <h4 class="date">2019-04-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/AirSensor/blob/master/vignettes/articles/outlier_detection.Rmd"><code>vignettes/articles/outlier_detection.Rmd</code></a></small>
      <div class="hidden name"><code>outlier_detection.Rmd</code></div>

    </div>

    
    
<p>This vignette explores the use of the <code><a href="../../reference/pat_outliers.html">pat_outliers()</a></code> function to identify and potentially replace timeseries outliers in the data and the underlying algorithm used that makes this possible.</p>
<div id="a-quick-example" class="section level2">
<h2 class="hasAnchor">
<a href="#a-quick-example" class="anchor"></a>A quick example</h2>
<p>Raw PurpleAir PM 2.5 time series data will occasionally contain visible outliers – measurements which are not plausibly explained by atmospheric processes and thus likely due to sensor error. Some monitors are noisier than others, but a week’s worth of data from any sensor will likely contain some of these electrical glitches.</p>
<p>Using example data released with the package, let’s have a look at the raw PM2.5 measurements for a Seattle based sensor during the first week of August, 2018. We will use the <code>sampleSize = 1e6</code> argument to prevent sub sampling of the data that might leave out some outliers. <em>(We’re willing to wait for the plot so we can see everything!)</em></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">pat &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="st">  </span>AirSensor<span class="op">::</span>example_pat <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../reference/pat_filterDate.html">pat_filterDate</a></span>(<span class="st">"2018-08-01"</span>,<span class="st">"2018-08-07"</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="../../reference/pat_multiPlot.html">pat_multiPlot</a></span>(pat, <span class="dt">plottype =</span> <span class="st">"pm25"</span>, <span class="dt">sampleSize =</span> <span class="fl">1e6</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 2161 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 2160 rows containing missing values (geom_point).</code></pre>
<p><img src="outlier_detection_files/figure-html/quick_example-1.png" width="672"></p>
<p>We definitely see a few individual data points that look like outliers while other momentarily elevated levels consist of multiple measurements and are more likely to represent valid measurements.</p>
<p>Let’s see if our outlier detector can correctly identify outliers without flagging the more believable measurements:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../../reference/pat_outliers.html">pat_outliers</a></span>(pat, <span class="dt">showPlot =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="outlier_detection_files/figure-html/pat_outliers-1.png" width="672"></p>
<p>An excellent result!</p>
</div>
<div id="the-hampel-filter" class="section level2">
<h2 class="hasAnchor">
<a href="#the-hampel-filter" class="anchor"></a>The Hampel Filter</h2>
<p>The <a href="https://cran.r-project.org/web/packages/seismicRoll/index.html">seismicRoll</a> R package was developed for use with high resolution seismology waveforms. It provides high performance functions for a variety of signal processing algorithms including the Hampel Filter.</p>
<p>The <code>pat_outlier()</code> function uses the Hampel filter to identify outliers. The Hampel filter is a robust outlier detector that uses <a href="https://en.wikipedia.org/wiki/Median_absolute_deviation">Median Absolute Deviation</a>. For each point, a median and standard deviation are calculated using all neighboring values within a window of size <code>windowSize</code>. If the point of interest lies multiple standard deviations from the median it is flagged as an outlier. As the Hampel value increases, the more likely it is that the value is an outlier. However, there is no universally appropriate window size or threshold to use. It’s up to us to come up with our own window size and threshold based on the characteristics of our time series.</p>
<p>Detailed discussion of the algorithm is available at:</p>
<ul>
<li>
<a href="https://www.mathworks.com/help/dsp/ref/hampelfilter.html">Hampel Filter</a> – Matlab function documentation</li>
<li>
<a href="https://link.springer.com/article/10.1186/s13634-016-0383-6">Generalized Hampel Filter</a> – Journal on Advances in Signal Processing</li>
</ul>
<div id="window-width-and-detection-threshold" class="section level3">
<h3 class="hasAnchor">
<a href="#window-width-and-detection-threshold" class="anchor"></a>Window width and detection threshold</h3>
<p>The <code><a href="../../reference/pat_outliers.html">pat_outliers()</a></code> function provides two parameters to control outlier detection:</p>
<ul>
<li>
<code>windowSize</code> – number of measurements to include in a window</li>
<li>
<code>thresholdMin</code> – number of std. dev. units above which a measurement is considered an outlier</li>
</ul>
<p>The default setting of <code>windowSize = 23</code> means that 23 samples from a single channel become the population from which the median and standard deviation are calculated. Each Purple Air channel makes a measurement approximately every 80 seconds so the temporal window is 23 * 80 sec or approximately 30 minutes. This seems like a reasonable period of time over which to evaluate PM2.5 measurements. It is long enough to capture significant change making it more likely we will only identify true outliers.</p>
<p>The default setting for the detection threshold <code>thresholdMin = 8</code> means that the sample at the center of the rolling window must have a value at least 8 standard deviation units away from the window median to be flagged as an outlier.</p>
<p>To explain how this works, we will focus on a single day’s worth of data and use base R functionality to zoom in and visually explore the algorithm. We start with a visual inspection of the data:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">oneDayData &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="st">  </span>pat <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../reference/pat_filterDate.html">pat_filterDate</a></span>(<span class="st">"2018-08-03"</span>, <span class="dt">days =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../reference/pat_extractDataFrame.html">pat_extractData</a></span>()</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co"># Visually inspect for outliers</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(oneDayData<span class="op">$</span>datetime, oneDayData<span class="op">$</span>pm25_A, </a>
<a class="sourceLine" id="cb5-8" data-line-number="8">     <span class="dt">xlab =</span> <span class="st">"Aug 1, 21018"</span>, <span class="dt">ylab =</span> <span class="st">"ug/m3"</span>, <span class="dt">las =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="st">"A channel PM2.5"</span>)</a></code></pre></div>
<p><img src="outlier_detection_files/figure-html/visual_inspection-1.png" width="672"></p>
<p>We definitely have what looks to the eye like outliers so let’s use the <code><a href="https://rdrr.io/pkg/seismicRoll/man/findOutliers.html">seismicRoll::findOutliers()</a></code> function to figure out exactly where they are:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Find the outliers</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">seismicRoll<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/seismicRoll/man/findOutliers.html">findOutliers</a></span>(oneDayData<span class="op">$</span>pm25_A)</a></code></pre></div>
<pre><code>## [1] 872 874</code></pre>
<p>The following example explains the outlier detection process with a single window centered on the outlier at index <code>872</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># Set example point, neighbors, median, and window</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">windowWidth &lt;-<span class="st"> </span><span class="dv">23</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">halfWidth &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="dv">23</span><span class="op">/</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">exampleIndex &lt;-<span class="st"> </span><span class="dv">872</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">windowStart &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(exampleIndex <span class="op">-</span><span class="st"> </span>halfWidth)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">windowEnd &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(exampleIndex <span class="op">+</span><span class="st"> </span>halfWidth)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">exampleNeighbors &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(windowStart<span class="op">:</span>(exampleIndex <span class="op">-</span><span class="st"> </span><span class="dv">1</span>), (exampleIndex <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span>windowEnd)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">windowMedian &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(oneDayData<span class="op">$</span>pm25_A[exampleNeighbors], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">windowSd &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(oneDayData<span class="op">$</span>pm25_A[exampleNeighbors], <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co"># Plot the window around the example point along with the window median</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(oneDayData<span class="op">$</span>datetime_A[windowStart<span class="op">:</span>windowEnd], </a>
<a class="sourceLine" id="cb8-13" data-line-number="13">     oneDayData<span class="op">$</span>pm25_A[windowStart<span class="op">:</span>windowEnd],</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">     <span class="dt">col =</span> <span class="st">"black"</span>, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">     <span class="dt">main =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Window Around Measurement #"</span>, exampleIndex),</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">     <span class="dt">las =</span> <span class="dv">1</span>, <span class="dt">xlab =</span> <span class="st">"Time (UTC)"</span>, <span class="dt">ylab =</span> <span class="st">"PM 2.5 (ug/m3)"</span>)</a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="kw"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(oneDayData<span class="op">$</span>datetime_A[exampleIndex], </a>
<a class="sourceLine" id="cb8-18" data-line-number="18">       oneDayData<span class="op">$</span>pm25_A[exampleIndex],</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">       <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">pch =</span> <span class="dv">16</span>, <span class="dt">cex =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb8-20" data-line-number="20"><span class="co"># Add lines for the median and several standard deviations beyond</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h =</span> windowMedian, <span class="dt">col =</span> <span class="st">"blue"</span>)</a>
<a class="sourceLine" id="cb8-22" data-line-number="22"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">h =</span> windowMedian <span class="op">+</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span> <span class="op">*</span><span class="st"> </span>windowSd, </a>
<a class="sourceLine" id="cb8-23" data-line-number="23">       <span class="dt">lty =</span> <span class="st">"dashed"</span>, <span class="dt">col =</span> <span class="st">"orange"</span>)</a>
<a class="sourceLine" id="cb8-24" data-line-number="24"><span class="co"># Add a legend</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25"><span class="kw"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="dt">x =</span> <span class="st">"topright"</span>,</a>
<a class="sourceLine" id="cb8-26" data-line-number="26">       <span class="dt">legend =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Point of Interest"</span>, </a>
<a class="sourceLine" id="cb8-27" data-line-number="27">                  <span class="st">"Neighbors"</span>, </a>
<a class="sourceLine" id="cb8-28" data-line-number="28">                  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Median = "</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(windowMedian,<span class="dv">2</span>)),</a>
<a class="sourceLine" id="cb8-29" data-line-number="29">                  <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Stddev = "</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(windowSd,<span class="dv">2</span>))),</a>
<a class="sourceLine" id="cb8-30" data-line-number="30">       <span class="dt">col =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"red"</span>, <span class="st">"black"</span>, <span class="st">"blue"</span>, <span class="st">"orange"</span>),</a>
<a class="sourceLine" id="cb8-31" data-line-number="31">       <span class="dt">lwd =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>), </a>
<a class="sourceLine" id="cb8-32" data-line-number="32">       <span class="dt">lty =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="ot">NA</span>, <span class="ot">NA</span>, <span class="st">"solid"</span>, <span class="st">"dashed"</span>), </a>
<a class="sourceLine" id="cb8-33" data-line-number="33">       <span class="dt">pch =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">16</span>, <span class="dv">16</span>, <span class="ot">NA</span>, <span class="ot">NA</span>))</a></code></pre></div>
<p><img src="outlier_detection_files/figure-html/hampel_window-1.png" width="672"></p>
<p>The example code above can be applied to any outliers identified with <code><a href="https://rdrr.io/pkg/seismicRoll/man/findOutliers.html">seismicRoll::findOutliers()</a></code> to gain a better understanding of why each point is flagged as an outlier. Remember that this is a “rolling” algorithm and that the <code>windowMedian</code> and <code>windowSd</code> are recalculated for every single point in the timeseries.</p>
<p>If an outlier is detected even when it visually appears to lie on top of other data points it just means that the window-local median and standard deviation are very small, thus requiring much smaller deviations from the median to be flagged as an outlier.</p>
</div>
</div>
<div id="replacing-values" class="section level2">
<h2 class="hasAnchor">
<a href="#replacing-values" class="anchor"></a>Replacing values</h2>
<p>The <code>pat_outlier()</code> function allows you to replace detected outliers with the <code>windowMedian</code>, resulting in a cleaner timeseries with likely electrical glitches removed. The following plots demonstrate replacement of outliers.</p>
<div id="no-outlier-replacement" class="section level3">
<h3 class="hasAnchor">
<a href="#no-outlier-replacement" class="anchor"></a>No outlier replacement</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">pat2Day &lt;-</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../../reference/pat_filterDate.html">pat_filterDate</a></span>(pat, <span class="st">"2018-08-02"</span>, <span class="dt">days =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co"># No outlier replacement</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">pat2Day <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/pat_multiPlot.html">pat_multiPlot</a></span>(<span class="st">"pm25"</span>, <span class="dt">sampleSize =</span> <span class="fl">1e6</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 721 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 720 rows containing missing values (geom_point).</code></pre>
<p><img src="outlier_detection_files/figure-html/hampel_smoothing_0-1.png" width="672"></p>
</div>
<div id="default-outlier-replacement" class="section level3">
<h3 class="hasAnchor">
<a href="#default-outlier-replacement" class="anchor"></a>Default outlier replacement</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># Default outlier replacement</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">pat2Day <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../reference/pat_outliers.html">pat_outliers</a></span>(<span class="dt">windowSize =</span> <span class="dv">23</span>, <span class="dt">thresholdMin =</span> <span class="dv">8</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../reference/pat_multiPlot.html">pat_multiPlot</a></span>(<span class="st">"pm25"</span>, <span class="dt">sampleSize =</span> <span class="fl">1e6</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 721 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 720 rows containing missing values (geom_point).</code></pre>
<p><img src="outlier_detection_files/figure-html/hampel_smoothing_1-1.png" width="672"><img src="outlier_detection_files/figure-html/hampel_smoothing_1-2.png" width="672"></p>
</div>
<div id="aggressive-outlier-replacement" class="section level3">
<h3 class="hasAnchor">
<a href="#aggressive-outlier-replacement" class="anchor"></a>Aggressive outlier replacement</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># Aggressive outlier replacement </span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2">pat2Day <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../../reference/pat_outliers.html">pat_outliers</a></span>(<span class="dt">windowSize =</span> <span class="dv">23</span>, <span class="dt">thresholdMin =</span> <span class="dv">4</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../reference/pat_multiPlot.html">pat_multiPlot</a></span>(<span class="st">"pm25"</span>, <span class="dt">sampleSize =</span> <span class="fl">1e6</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 721 rows containing missing values (geom_point).</code></pre>
<pre><code>## Warning: Removed 720 rows containing missing values (geom_point).</code></pre>
<p><img src="outlier_detection_files/figure-html/hampel_smoothing_2-1.png" width="672"><img src="outlier_detection_files/figure-html/hampel_smoothing_2-2.png" width="672"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#a-quick-example">A quick example</a></li>
      <li><a href="#the-hampel-filter">The Hampel Filter</a></li>
      <li><a href="#replacing-values">Replacing values</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan, Hans Martin, Kayleigh Wilson, Tate Brasel, Helen Miller.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
