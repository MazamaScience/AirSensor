<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom QC Algorithms • AirSensor</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Custom QC Algorithms">
<meta property="og:description" content="AirSensor">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">AirSensor</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/AirSensor_Function_Overview.html">AirSensor Function Overview</a>
    </li>
    <li>
      <a href="../../articles/Developer_Style_Guide.html">Developer Style Guide</a>
    </li>
    <li>
      <a href="../../articles/articles/Australia_on_fire.html">Australia on Fire</a>
    </li>
    <li>
      <a href="../../articles/articles/Custom_QC_Algorithms.html">Custom QC Algorithms</a>
    </li>
    <li>
      <a href="../../articles/articles/DataFlowChart.html">Processing PurpleAir Data</a>
    </li>
    <li>
      <a href="../../articles/articles/SoH_functions.html">SoH Functions</a>
    </li>
    <li>
      <a href="../../articles/articles/Temporal_Aggregation.html">Temporally Aggregated Time Series</a>
    </li>
    <li>
      <a href="../../articles/articles/outlier_detection.html">Outlier Detection with the Hampel Filter</a>
    </li>
    <li>
      <a href="../../articles/articles/pas_introduction.html">PurpleAir Synoptic Data</a>
    </li>
    <li>
      <a href="../../articles/articles/pat_introduction.html">PurpleAir Time Series Data</a>
    </li>
    <li>
      <a href="../../articles/articles/purpleair_failure_modes.html">PurpleAir Failure Modes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/AirSensor/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Custom_QC_Algorithms_files/header-attrs-2.5/header-attrs.js"></script><link href="Custom_QC_Algorithms_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="Custom_QC_Algorithms_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Custom QC Algorithms</h1>
                        <h4 class="author">Mazama Science</h4>
            
            <h4 class="date">2020-06-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/AirSensor/blob/master/vignettes/articles/Custom_QC_Algorithms.Rmd"><code>vignettes/articles/Custom_QC_Algorithms.Rmd</code></a></small>
      <div class="hidden name"><code>Custom_QC_Algorithms.Rmd</code></div>

    </div>

    
    
<p>Data quality-control is the process of flagging or removing invalid or noise data points from a data set, either manually or algorithmicly. There are many statistical techniques and methods to preform quality-control. In this article we provide a general overview of how to construct such algorithms for use within the <strong>AirSensor</strong> package. Our goal is to write custom quality-control functions that replace, flag, or remove invalid data points. Data that are out of an instrument’s specifications, that appear to be associated with random noise or are associated with other known issues can be considered invalid.</p>
<p>NOTE: If you haven’t yet read the <em>Temporal Aggregation</em> article, you should read it first in order to understand advanced usage of <code><a href="../../reference/pat_aggregate.html">pat_aggregate()</a></code>.</p>
<div id="example-1-count-based-qc" class="section level2">
<h2 class="hasAnchor">
<a href="#example-1-count-based-qc" class="anchor"></a>Example 1 – Count based QC</h2>
<p>Let’s start by creating a simple QC algorithm based on the count of the number of data records within an hour. If the count of records is too low, we will replace any aggregated value with <code>NA</code>, otherwise we will return the hourly aggregated value, in this example the <code>mean</code>.</p>
<p>This QC function will create two hourly-aggregated ‘pat’ objects – <code>mean_pat</code> and <code>count_pat</code> and use data from <code>count_pat</code> to invalidate some records in <code>mean_pat</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MazamaScience/AirSensor">AirSensor</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load a PurpleAir Timeseries ('pat') object</span>
<span class="va">pat</span> <span class="op">&lt;-</span> <span class="va">example_pat</span>

<span class="co"># Define a QC function that returns an aggregated 'pat' object</span>
<span class="va">QC_hourly_count</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pat</span>, <span class="va">minCount</span> <span class="op">=</span> <span class="fl">11</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># Create mean hourly aggregate pat</span>
  <span class="va">mean_pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/pat_aggregate.html">pat_aggregate</a></span><span class="op">(</span><span class="va">pat</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># Create count of non-missing pat data</span>
  <span class="va">count_pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/pat_aggregate.html">pat_aggregate</a></span><span class="op">(</span><span class="va">pat</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># Create a minimum count mask</span>
  <span class="va">pm25_A_mask</span> <span class="op">&lt;-</span> <span class="va">count_pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pm25_A</span> <span class="op">&lt;</span> <span class="va">minCount</span>
  <span class="va">pm25_B_mask</span> <span class="op">&lt;-</span> <span class="va">count_pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pm25_B</span> <span class="op">&lt;</span> <span class="va">minCount</span>

  <span class="co">##################</span>
  <span class="co"># dplyr/tidyverse version</span>
  <span class="co">##################</span>
  <span class="co">#pat &lt;- mean_pat</span>
  <span class="co"># mean_pat$data &lt;-</span>
  <span class="co">#   mean_pat$data %&gt;%</span>
  <span class="co">#   mutate(pm25_A = replace(.data$pm25_A, pm25_A_mask, NA)) %&gt;%</span>
  <span class="co">#   mutate(pm25_B = replace(.data$pm25_B, pm25_B_mask, NA)) %&gt;%</span>
  <span class="co">#   mutate(hr_count_pm25_A = count_pat$data$pm25_A) %&gt;%</span>
  <span class="co">#   mutate(hr_count_pm25_B = count_pat$data$pm25_B)</span>
  <span class="co"># pat &lt;- mean_pat</span>

  <span class="co">##################</span>
  <span class="co"># base R version</span>
  <span class="co">##################</span>
  <span class="va">pat</span> <span class="op">&lt;-</span> <span class="va">mean_pat</span>
  <span class="va">pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pm25_A</span><span class="op">[</span><span class="va">pm25_A_mask</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pm25_B</span><span class="op">[</span><span class="va">pm25_B_mask</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
  <span class="va">pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">hr_count_pm25_A</span> <span class="op">&lt;-</span> <span class="va">count_pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pm25_A</span>
  <span class="va">pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">hr_count_pm25_B</span> <span class="op">&lt;-</span> <span class="va">count_pat</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">pm25_B</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pat</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="co"># Apply the QC function</span>
<span class="va">hourly_count_pat</span> <span class="op">&lt;-</span> <span class="fu">QC_hourly_count</span><span class="op">(</span><span class="va">pat</span>, minCount <span class="op">=</span> <span class="fl">42</span><span class="op">)</span>

<span class="co"># Examine the results</span>
<span class="fu"><a href="../../reference/timeseriesTbl_multiPlot.html">timeseriesTbl_multiPlot</a></span><span class="op">(</span><span class="va">hourly_count_pat</span><span class="op">$</span><span class="va">data</span>, pattern <span class="op">=</span> <span class="st">"pm25_[AB]"</span><span class="op">)</span></code></pre></div>
<p><img src="Custom_QC_Algorithms_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>In the code above, we calculate hourly aggregated average values, <code>mean_pat</code>, and hourly aggregated counts, <code>count_pat</code>. We use the counts to create a mask identifying hours where there is not enough data to meet our minimum threshold, <code>minCount = 42</code>. The mean values for these hours are replaced with <code>NA</code>.</p>
<p>Looking at the plot, we can verify that low count values are associated with missing values of <code>pm25_A/B</code>.</p>
</div>
<div id="example-2-z-score-based-qc" class="section level2">
<h2 class="hasAnchor">
<a href="#example-2-z-score-based-qc" class="anchor"></a>Example 2 – Z-score based QC</h2>
<p>In this example, we construct a more complex QC algorithm using advanced features of <code><a href="../../reference/pat_aggregate.html">pat_aggregate()</a></code> and a coding style appropriate for seasoned R developers.</p>
<p>The <code>FUN</code> parameter is defined “anonymously” (aka on-the-fly) and calculates a Z-score for each 20-minute period in the data. If the Z-score is below our <code>0.05</code> threshold, we replace it with <code>NA</code>. The 20-minute data is then re-aggregated to an 1-hour average and returned. Effectively, this quality-control function is a basic two-tailed Z-score filter that only aggregates data if the it is within the p-value (0.05).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">QC_hourly_z_score</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pat</span>, <span class="va">threshold</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">{</span>

  <span class="va">pat_z_scored_20min_avg</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="../../reference/pat_aggregate.html">pat_aggregate</a></span><span class="op">(</span>
      <span class="va">pat</span>,
      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
        <span class="co"># Caluclate x z-scores</span>
        <span class="va">z_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="co"># (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)</span>
        
        <span class="co"># Create z-score mask -</span>
        <span class="co"># flag the z-scores who are out of the 5% and 95% quantile range</span>
        <span class="va">z_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">z_score</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">threshold</span>
        <span class="va">x</span><span class="op">[</span><span class="va">z_mask</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
        
        <span class="co"># Calculate the 20-min average values without the flagged data</span>
        <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
        <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
      <span class="op">}</span>,
      unit <span class="op">=</span> <span class="st">'minutes'</span>,
      count <span class="op">=</span> <span class="fl">20</span>
    <span class="op">)</span>
  
  <span class="co"># Re-aggregate to an 1-hour average of the data</span>
  <span class="va">pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/pat_aggregate.html">pat_aggregate</a></span><span class="op">(</span><span class="va">pat_z_scored_20min_avg</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pat</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="va">hourly_z_score_pat</span> <span class="op">&lt;-</span> <span class="fu">QC_hourly_z_score</span><span class="op">(</span><span class="va">pat</span><span class="op">)</span>

<span class="co"># Examine the results</span>
<span class="fu"><a href="../../reference/timeseriesTbl_multiPlot.html">timeseriesTbl_multiPlot</a></span><span class="op">(</span><span class="va">hourly_z_score_pat</span><span class="op">$</span><span class="va">data</span>, pattern <span class="op">=</span> <span class="st">"pm25_[AB]"</span><span class="op">)</span></code></pre></div>
<p><img src="Custom_QC_Algorithms_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<hr>
<p>There are many ways to construct QC algorithms and the examples above illustrate what is possible within the <em>AirSensor</em> framework. We fully expect people to explore possibilities and create different QC algorithms depending on their individual needs:</p>
<ul>
<li>How important is it to remove all potentially bad data?</li>
<li>How important is it to retain all potentially good data?</li>
<li>Are there specific QC steps that required by an organization?</li>
<li>…</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan, Hans Martin, Kayleigh Wilson, Tate Brasel, Helen Miller.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
