---
title: "MVCAA Tutorial 4: Exploring Airsensor Data"
author: "Mazama Science"
date: "2021-03-09"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MVCAA Tutorial 4: Exploring Airsensor Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
knitr::opts_knit$set(root.dir = "C:/Users/astri/Mirror/Mazamascience/Projects/AirSensor")
```

## Introduction

This tutorial demonstrates how to analyze Airsensor data using designed AirSensor functions. 
In order to run the code in this tutoral you must have 
followed the instructions in Tutorial 3 and created a directory with 'pas', 'pat', and 'airsensor' 
data files for the Methow Valley. Target audiences include grad students, researchers and any member of the public
concerned about air quality and comfortable working with R and RStudio.

Tutorials in this series include:

* [MVCAA Tutorial 1: Creating PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_1.html)
* [MVCAA Tutorial 2: Exploring PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_2.html)
* [MVCAA Tutorial 3: Creating Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_3.html)
* [MVCAA Tutorial 4: Exploring Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_4.html)
* [MVCAA Tutorial 5: Building a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_5.html)
* [MVCAA Tutorial 6: Using a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_6.html)
* [MVCAA Tutorial 7: Methow Vallely Smoke](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_7.html)

## Goal

Our goal in this tutorial is to explore a variety of `sensor_~()` functions available
in the **AirSensor** package and to explain their most important arguments and 
the interpretation of output graphics.

```{r setup-data-directory, eval = FALSE, warning = FALSE, message = FALSE}
# Methow Valley local data archive

# ----- Setup ------------------------------------------------------------------

# Directory with Methow Valley data: 
# - choose "Option 1" if you created your data directory under your R home 
# directory (~).
# - choose "Option 2" if you created your data directory somewhere else.
# Then go ahead running the rest of the script.

# Option 1
path.expand("~") # if you want to check your current home directory (~)
archiveDir <- "~/Data/MVCAA"  

# Option 2
# Change "~" and keep "/Data/MVCAA".
# Example: "C:/MethowValley/Data/MVCAA".
DATA_DIR <- "~/Data/MVCAA" 

# assign you data directory to "archiveDir"
if ( exists("DATA_DIR") ) {
  archiveDir <- file.path(DATA_DIR)
} else {
  archiveDir <- file.path("~/Data/MVCAA")
}

# AirSensor package
library(AirSensor)

# Load previously generated airsensor data
airsensorList <- get(load(paste0(archiveDir,"/airsensorList.rda")))

# Print site names and associated ids
sapply(airsensorList, function(x) { return(x$meta$label) }) 

# Pull out each sensor as a separate 'airsensor' object
Balky_Hill <- airsensorList[["ab5dca99422f2c0d_13669"]]
Bush_School <- airsensorList[["49215ad49d1a87e3_10188"]]
Liberty_School <- airsensorList[["db5d6b3b79f5830e_39237"]]
McFarland_Creek <- airsensorList[["f592adb5067ad9d3_13675"]]
Pine_Forest <- airsensorList[["0cbfeb2ce4c1553c_13661"]]
Willowbrook_Farm <- airsensorList[["f96deab8c29aa42b_10134"]]
Benson_Creek <- airsensorList[["f6c44edd41c941c7_10182"]]
Gunn_Ranch <- airsensorList[["f736fd3fb21fc4da_13667"]]
Lower_Studhorse <- airsensorList[["4f19d256e1787973_10166"]]
Methow_Estates <- airsensorList[["4a47b9252e16e558_15077"]] 
Beaver_Creek <- airsensorList[["2e3b5ceea86a885b_10168"]]
Little_Cougar <- airsensorList[["96b108298883ca47_64441"]]
```

## [sensor_calendarPlot()](https://mazamascience.github.io/AirSensor/reference/pat_monitorComparison.html)

This function plots PM2.5 concentration in a calendar format and wraps the 
[openair](https://bookdown.org/david_carslaw/openair/) 
calendarPlot() function.

Let's explore a couple of sensors using the US EPA Air Quality Index colors, 
`colors = "aqi"`. This way, we can see which days during September 2020 had the 
worst PM2.5 levels, putting the health of the Methow Valley's population at risk.


```{r sensor-calendarPlots,eval = FALSE, warning = FALSE, message = FALSE}
# Create a calendar plot for Liberty School
sensor_calendarPlot(
  sensor = Liberty_School,
  colors = "aqi",
  breaks = NULL,
  labels = NULL,
  limits = c(0, 100),
  title = "September 2020 -- Liberty School",
  data.thresh = 50
)

# Create a calendar plot for Willowbrook Farm
sensor_calendarPlot(
  sensor = Willowbrook_Farm,
  colors = "aqi",
  breaks = NULL,
  labels = NULL,
  limits = c(0, 100),
  title = "September 2020 -- Willowbrook Farm",
  data.thresh = 50
)
```
From the calendar plots we see that the second and third weeks of September were 
the smokiest as revealed by the Liberty School sensor. Calendar plots are also 
an easy way to quickly visualize missing data. This
allow us to promptly evaluate which sensor to include in future analyses. 
The Willowbrook Farm sensor had 11 days of mising data, probably the smokiest. 
It would be risky to include this sensor in future analysis, since it's not 
representative of the air quality conditions of September 2020. 

## [sensor_polarPlot()](https://mazamascience.github.io/AirSensor/reference/sensor_polarPlot.html)
This function plots PM2.5 concentration in polar coordinates showing concentration 
by wind speed and direction. This function wraps the openair polarPlot() function.

If no wind data is specified, `windData = NULL`, the function uses wind data 
of the nearest airport station obtained with the [worldmet](https://www.rdocumentation.org/packages/worldmet/versions/0.9.2/topics/worldmet) 
package. 

The colour scale for some of the statistics is only to provide an indication of overall 
pattern and should not be interpreted in concentration units (Âµg/m3). 

```{r sensor-polarPlot-Liberty_School, eval = FALSE, warning = FALSE, message = FALSE}
# Create a polar plot for Liberty School
polar_plot <- sensor_polarPlot(
  sensor = Liberty_School,
  windData = NULL,
  statistic = "mean",
  resolution = "fine",
  colors = "default",
  alpha = 1,
  angleScale = 315,
  normalize = FALSE,
  key = TRUE,
  keyPosition = "right",
  ws_spread = 15,
  wd_spread = 4,
  verbose = TRUE
)
```
The plot shows that there is eveidence of increasing PM25 concentrations as the 
wind speed (ws) decreases from all direction and mostly from N.

To see the wind speed/direction conditions that dominate the overall mean, we 
can use `statistic = "weighted_mean"`. As we can see from the plot below, wind 
from N with a speed beteen 6 and 4 m/s carries the highest PM25 concentration. 
```{r sensor-polarPlot-Liberty_School-wm, eval = FALSE, warning = FALSE, message = FALSE}
# Create a polar plot for Liberty School
polar_plot <- sensor_polarPlot(
  sensor = Liberty_School,
  windData = NULL,
  statistic = "weighted_mean",
  resolution = "fine",
  colors = "default",
  alpha = 1,
  angleScale = 315,
  normalize = FALSE,
  key = TRUE,
  keyPosition = "right",
  ws_spread = 15,
  wd_spread = 4,
  verbose = TRUE
)
```

## [sensor_pollutionRose()](https://mazamascience.github.io/AirSensor/reference/sensor_pollutionRose.html)
This fucntion plots a traditional wind rose plot for wind direction and PM2.5.
Wind speed data can be accessed by saving the the output into an R object. 
```{r sensor_pollutionRose,eval = FALSE, warning = FALSE, message = FALSE}
poll_rose <- sensor_pollutionRose(
  sensor = Liberty_School,
  windData = NULL,
  statistic = "prop.count",
  key = TRUE,
  keyPosition = "right",
  annotate = TRUE,
  angle = 30,
  angleScale = 315,
  gridLine = NULL,
  breaks = 6,
  paddle = FALSE,
  seg = 0.9,
  normalize = FALSE,
  verbose = TRUE
)
```

```{r sensor_pollutionRose,eval = FALSE, warning = FALSE, message = FALSE}
poll_rose <- sensor_pollutionRose(
  sensor = Liberty_School,
  windData = NULL,
  statistic = "abs.count",
  key = TRUE,
  keyPosition = "right",
  annotate = TRUE,
  angle = 30,
  angleScale = 315,
  gridLine = NULL,
  breaks = 6,
  paddle = FALSE,
  seg = 0.9,
  normalize = FALSE,
  verbose = TRUE
)
```
The plot shows that higher PM25 concentrations are not strongly associated with a 
particular direction, however wind from N seems to carry more PM25 particles 
than any other direction.
**left here **

```{r-to-be-removed, warning = FALSE, message = FALSE}
# trying to plot the plots next to each other (https://bookdown.org/david_carslaw/openair/sec-openair-package.html#sec:multiple-plots-page)
print(polar_plot, split = c(1,1,2,1))
print(poll_rose, split = c(2,1,2,1))
```

## sensor_extractData()
```{r sensor_extractData, eval=FALSE}
sensor_extractData()
# can then be exported with readr::write_csv()
```

## timeseriesTbl_multiPlot() 
```{r timeseriesTbl_multiPlot, eval=FALSE}
timeseriesTbl_multiPlot() 
```

## More examples with PWFSLSmoke and AirMonitorPlots
```{r PWFSLSmoke - AirMonitorPlots, eval=FALSE }
# include some examples using functions from PWFSLSmoke or AirMonitorPlots 
```


_Best of luck assessing air quality in your community!_
