---
title: "MVCAA Tutorial 4: Exploring Airsensor Data"
author: "Mazama Science"
date: "2021-03-09"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MVCAA Tutorial 4: Exploring Airsensor Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
```

## Introduction

This tutorial demonstrates how to analyze 'airsensor' data using functions
tailored to that data type, all of which have names beginning with `airsensor_`. 
In order to run the code in this tutoral you must have 
followed the instructions in Tutorials 1-33 and created a directory with 'pas', 
'pat', and 'airsensor' data files for the Methow Valley. Target audiences 
include grad students, researchers and any member of the public
concerned about air quality and comfortable working with R and RStudio.

Tutorials in this series include:

* [MVCAA Tutorial 1: Creating PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_1.html)
* [MVCAA Tutorial 2: Exploring PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_2.html)
* [MVCAA Tutorial 3: Creating Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_3.html)
* [MVCAA Tutorial 4: Exploring Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_4.html)
* [MVCAA Tutorial 5: Building a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_5.html)
* [MVCAA Tutorial 6: Using a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_6.html)
* [MVCAA Tutorial 7: Methow Vallely Smoke](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_7.html)

## Goal

Our goal in this tutorial is to explore a variety of `sensor_~()` functions available
in the **AirSensor** package and to explain their most important arguments and 
the interpretation of output graphics.

```{r setup-data-directory, eval = TRUE, warning = FALSE, message = FALSE}
# Methow Valley local data archive

# ----- Setup ------------------------------------------------------------------

library(AirSensor)

# Use the default archiveDir unless it is already defined
if ( !exists("archiveDir") ) {
  archiveDir <- file.path("~/Data/MVCAA")
}

# Load previously generated airsensor data
airsensorList <- get(load(file.path(archiveDir,"airsensorList.rda")))

# Print site names and associated ids
sapply(airsensorList, function(x) { return(x$meta$label) }) 

# Pull out each sensor as a separate 'airsensor' object
Balky_Hill <- airsensorList[["ab5dca99422f2c0d_13669"]]
Bush_School <- airsensorList[["49215ad49d1a87e3_10188"]]
Liberty_School <- airsensorList[["db5d6b3b79f5830e_39237"]]
McFarland_Creek <- airsensorList[["f592adb5067ad9d3_13675"]]
Pine_Forest <- airsensorList[["0cbfeb2ce4c1553c_13661"]]
Willowbrook_Farm <- airsensorList[["f96deab8c29aa42b_10134"]]
Benson_Creek <- airsensorList[["f6c44edd41c941c7_10182"]]
Gunn_Ranch <- airsensorList[["f736fd3fb21fc4da_13667"]]
Lower_Studhorse <- airsensorList[["4f19d256e1787973_10166"]]
Methow_Estates <- airsensorList[["4a47b9252e16e558_15077"]] 
Beaver_Creek <- airsensorList[["2e3b5ceea86a885b_10168"]]
Little_Cougar <- airsensorList[["96b108298883ca47_64441"]]
```

## sensor_calendarPlot

The [sensor_calendarPlot()](https://mazamascience.github.io/AirSensor/reference/pat_monitorComparison.html)
function plots PM2.5 concentration in a calendar format. This function is 
prepares data and ultimately calls the 
[openair](https://bookdown.org/david_carslaw/openair/) package
`calendarPlot()` function.

From the final plot in Tutorial 3, it is clear that the sensor labeled "Pine Forest" 
has the most complete data after hourly aggregation. Let's look at air quality 
impacts at "Pine Forest" using the 
[US EPA Air Quality Index colors](https://www.epa.gov/wildfire-smoke-course/wildfire-smoke-and-your-patients-health-air-quality-index), 
`colors = "aqi"`. We expect that the PM2.5 values reported by the sensor will be exaggerated
to some extent. Nevertheless, the calendar plot will still show us which days during 
September 2020 had the worst PM2.5 levels, putting the health of Methow Valley 
residents at risk.

```{r sensor-calendarPlots, eval = TRUE, warning = FALSE, message = FALSE}
# Create a calendar plot for Liberty School
sensor_calendarPlot(
  sensor = Pine_Forest,
  colors = "aqi",
  title = "September 2020 -- Pine Forest"
)
```

From the calendar plot we see that the September 8-18 were all days of dangerous
smoke levels with September 13-14 being the worst days.

## sensor_polarPlot

The [sensor_polarPlot()](https://mazamascience.github.io/AirSensor/reference/sensor_polarPlot.html)
function wraps `openair::polarPlot()` which plots PM2.5 concentration as a 
function of wind speed and direction. This type of plot can be very helpful in
determining the source of a pollutant. See the documentation for `sensor_polarPlot()`
for details.

If no wind data is specified, (default) `windData = NULL`, the function uses 
wind data from the nearest airport station obtained with the 
[worldmet](https://www.rdocumentation.org/packages/worldmet/versions/0.9.2/topics/worldmet) 
package. 

The color scale for some of the statistics is only to provide an indication of 
overall pattern and should not be interpreted in concentration units (Âµg/m3). 

```{r sensor-polarPlot-Liberty_School, eval = TRUE, warning = FALSE, message = FALSE}
# Create a polar plot for Liberty School
polar_plot <- sensor_polarPlot(
  sensor = Liberty_School
)
```

The plot shows that there is evidence of increasing PM25 (smoke) concentrations 
at low wind speeds from all direction with more smoke coming from from the north.
If you look at a map a function from the **PWFSLSmoke** package, 
you will see that the Methow 
Valley runs primarily north-south at Liberty Bell High School.

```{r monitor_leaflet, eval = TRUE, warning = FALSE, message = FALSE}
PWFSLSmoke::monitor_leaflet(Liberty_School)
```

To see the wind speed/direction conditions that dominate the overall mean, we 
can use `statistic = "weighted_mean"`. As we can see from the plot below, wind 
from N with a speed between 6 and 4 m/s carries the highest PM25 concentration. 

This plot might suggest that wildfire smoke that entered the valley moved 
up and down the valley as part of typical, diurnal valley airflow patterns.

```{r sensor-polarPlot-Liberty_School-wm, eval = TRUE, warning = FALSE, message = FALSE}
# Create a polar plot for Liberty School using the weighted mean
polar_plot <- sensor_polarPlot(
  sensor = Pine_Forest,
  statistic = "weighted_mean"
)
```

## sensor_pollutionRose

The [sensor_pollutionRose()](https://mazamascience.github.io/AirSensor/reference/sensor_pollutionRose.html)
function plots a traditional wind rose plot for wind direction and PM2.5.
Wind speed data can be accessed by saving the the output into an R object. 

```{r sensor_pollutionRose_1, eval = TRUE, warning = FALSE, message = FALSE}
# Create a pollution rose plot for Liberty School using the proportion of the 
# frequency of measurements 
pollution_rose <- sensor_pollutionRose(
  sensor = Liberty_School
)
```

Highest PM25 concentrations are mostly associated with southerly winds. However 
the largest proportion of PM25 concentrations is associated with northerly winds.
By setting `statistic = "prop.mean"`, we can see that indeed northerly winds 
contribute the most to overall concentrations as shown in the plot below. 

```{r sensor_pollutionRose_2, eval = TRUE, warning = FALSE, message = FALSE}
# Create a pollution rose plot for Liberty School using the relative contribution 
# of the measurements to the mean
sensor_pollutionRose(
  sensor = Liberty_School,
  statistic = "prop.mean"
)
```

More examples and explanations on how to interpret pollution rose plots can be 
found in 
["Section 5 Wind and Pollution Roses"](https://bookdown.org/david_carslaw/openair/sec-windRose.html) 
of The Openair Book. 

```{r to-be-removed, eval = FALSE, warning = FALSE, message = FALSE}
# trying to plot the plots next to each other (https://bookdown.org/david_carslaw/openair/sec-openair-package.html#sec:multiple-plots-page)
print(polar_plot, split = c(1,1,2,1))
print(pollution_rose, split = c(2,1,2,1))
```

## sensor_extractData

The [sensor_extractData() and sensor_extractMeta() ](https://mazamascience.github.io/AirSensor/reference/sensor_extractDataFrame.html)
functions are convenient wrappers for extracting the dataframes that comprise 
an airsensor object. These functions are designed to be useful when manipulating 
data in a pipeline chain using `%>%`.

```{r sensor_extractData, eval = FALSE, warning = FALSE, message = FALSE}
# Explore data and metadata of Liberty_School 
data <- sensor_extractData(Liberty_School) # equivalent opration sensor[["data"]]
meta <- sensor_extractMeta(Liberty_School) # equivalent opration sensor[["meta"]]

# can then be exported with readr::write_csv()
readr::write_csv(data, file = paste0(archiveDir,"/", "Liberty_data.csv"))
list.files(archiveDir)

# pipeline chain example  
library(ggplot2)
library(AirMonitorPlots)

Liberty_School$meta$deviceDeploymentID
Smoky_days <- Liberty_School %>%
   sensor_filterDate(
    startdate = "2020-09-8", 
    enddate = "2020-09-18",
    timezone = "UTC"
  ) %>%
  sensor_extractData() %>%
  ggplot(mapping = aes(x = datetime, y = db5d6b3b79f5830e_39237)) +
  labs(title = "Unhealthy days - 09/2020 - Liberty School",
         x = "days",
         y = "PM25") +
  stat_AQCategory(color = NA) 

print(Smoky_days)
```


## timeseriesTbl_multiPlot() 

A plotting function that uses ggplot2 to display a suite of timeseries plots all 
at once.
```{r timeseriesTbl_multiPlot, eval = TRUE, warning = FALSE, message = FALSE}
Liberty_School %>%
  sensor_extractData() %>%
  timeseriesTbl_multiPlot() 
```

## More examples with PWFSLSmoke and AirMonitorPlots
**left here**
```{r PWFSLSmoke-AirMonitorPlots, eval = FALSE, warning = FALSE, message = FALSE}
# include some examples using functions from PWFSLSmoke or AirMonitorPlots 

# Create an interactive map of all PA sensor 
PWFSLSmoke::monitor_leaflet(my_monitors) # my_monitors was created in Tutorial 3
PWFSLSmoke::monitor_rollingMeanPlot(Liberty_School)
PWFSLSmoke::monitor_dailyBarplot(Liberty_School)

```

```{r}

```



_Best of luck assessing air quality in your community!_
