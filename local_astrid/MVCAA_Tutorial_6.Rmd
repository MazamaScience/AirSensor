---
title: "MVCAA Tutorial 6: Methow Vallely Smoke"
author: "Mazama Science"
date: "2021-03-22"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MVCAA Tutorial 5: Building a Local Archive}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
```
left at line 78 -- WIP

## Introduction

_TO DO_

Tutorials in this series include:

* [MVCAA Tutorial 1: Creating PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_1.html)
* [MVCAA Tutorial 2: Exploring PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_2.html)
* [MVCAA Tutorial 3: Creating Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_3.html)
* [MVCAA Tutorial 4: Exploring Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_4.html)
* [MVCAA Tutorial 5: Building a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_5.html)
* [MVCAA Tutorial 6: Methow Vallely Smoke](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_6.html)

## Goal
_TO DO_

# Outline:

## Overarching question: 

How would you decide if sensors work?

## Intro
On September 6 and 7 two wildfires were ignited not far from the Methow Valley – 
Cold Springs and Pearl Hill, which burned over 410,000 acres throughout the month.
Additionally, at the beginning of September several wildfires exploded in the 
southern, central and northern Oregon, and a “super massive” plume was carried 
to Washington State by the southerly winds. Eventually the smoke settled in the 
valleys and basins of Washington and air pollution reached unhealthy levels 
across the state (https://wasmoke.blogspot.com/). 
Let's see how Purple Air sensors performed compared to federal monitors in the 
Methow Valley.


## Compare monitor to nearest sensors:

* find monitors and nearest sensors (create a map?)

* see timeseries for both

* check fit

* what could have gone wrong?

## Data and graphics 

```{r prep-monitor-data, eval = TRUE, warning = FALSE, message = FALSE}

# find federal monitors in the Methow Valley
# define longitude and latitude 
xlim <- c(-120.093, -120.284)
ylim <- c(48.313, 48.510)

# load Sep data
mv_monitors <- PWFSLSmoke::monitor_load(startdate = 20200901, enddate = 20201001) %>%
  monitor_subset(xlim = xlim, ylim = ylim)

# select only columns of interest for federal monitors 
names(mv_monitors$meta)
mv_monitors_meta <- as_tibble(mv_monitors$meta) %>%
  select(monitorID, siteName, longitude, latitude)

print(mv_monitors_meta$siteName) #"Winthrop-Chewuch Rd" "Twisp-Glover St" 

```

```{r prep-sensor-data, eval = TRUE, warning = FALSE, message = FALSE}
# Use the tutorial default archiveDir unless it is already defined
if ( !exists("archiveDir") ) {
  archiveDir <- file.path("~/Data/MVCAA")
}

setArchiveBaseDir(archiveDir)

# Set your archive base directory and check that is correct
setArchiveBaseDir(archiveDir)
getArchiveBaseDir()

# find sensors close to the monitor Winthrop-Chewuch Rd
sensors <- pas_filterNear(pas = mvcaa, longitude = -120.1906, latitude = 48.47720, 
               radius = "5 km")

# select only columns of interest for federal monitors 
names(sensors)
sensors_meta <- as_tibble(sensors) %>%
  select(label, deviceDeploymentID, latitude, longitude)

# create sensor IDs object (must be as.character())
sensorIDs <- as.character(unique(sensors_meta$deviceDeploymentID))
print(sensorIDs) # 3 sensors 

# subset airsensor file for Sep using sensorIDs
sensors_subset <- 
  sensor_load(
    collection = "mvcaa",  
    startdate = 20200901,
    enddate = 20201001,
    timezone = "America/Los_Angeles") %>%
  monitor_subset(monitorIDs = sensorIDs)

# check if all 3 sensors are present
print(sensors_subset$meta$deviceDeploymentID)
# since we didn't have data for b56c0ef677852913_81495 during Sep, 
# this sensor is not present.

```

```{r timeseries-monitor, eval = TRUE, warning = FALSE, message = FALSE}
# create a timeseries for monitor Winthrop-Chewuch Rd
Winthrop <- mv_monitors %>%
  monitor_subset(monitorIDs = "530470010_01")

monitor_timeseriesPlot(Winthrop, style = 'gnats')
title('Winthrop, Sep 2020')
addAQILines()
addAQILegend(cex = 0.7)
```

```{r timeseries-sensors, eval = TRUE, warning = FALSE, message = FALSE}
# create short name for timeseries title 
sensors_subset$meta$shortName <-
  sensors_subset$meta$siteName %>%
  stringr::str_replace("MV Clean Air Ambassador @", "") %>%
  stringr::str_replace("MV Clean Air Ambassador-", "") %>%
  stringr::str_trim()

# create timeseries for the 2 sensors 
layout(matrix(seq(2)))
opar <- par(mar = c(1,1,1,1))
on.exit(par(opar))
for (ID in sensorIDs) {
  siteName <- sensors_subset$meta[ID, 'siteName']
  title <- sensors_subset$meta[ID, 'shortName']
  monitor_timeseriesPlot(
    sensors_subset,
    monitorID = ID,
    main = siteName,
    style = 'gnats',
  )
  title(title)
  addAQILines()
  addAQILegend(cex = 0.7)
}
par(opar)
layout(1)
```
 
We can see that the monitor and sensors recorded increasing PM25
concentrations up to very unhealthy levels between Sep 10 and 20. 
Lets see how the sensors performed individually and compared to the monitor.

```{r more-data-exploration, eval = TRUE, warning = FALSE, message = FALSE}

```


```{r overview-timeseries-fall, eval = TRUE, warning = FALSE, message = FALSE}
# maybe to be included 
# Load the all-hourly-data-combined sensor object
all_sensors_fall <- 
  sensor_load(
    collection = "mvcaa", # collectionName defined by user 
    startdate = 20200901,
    enddate = 20201201,
    timezone = "America/Los_Angeles"
  )

# Plot all hourly values with daily averages
all_sensors_fall %>%
  AirMonitorPlots::ggplot_pm25Timeseries() + 
  ggplot2::ggtitle("Methow Valley -- September, 2020") +
  AirMonitorPlots::geom_pm25Points(shape = "square", alpha = .1) + 
  AirMonitorPlots::stat_dailyAQCategory(alpha = .5) + 
  ggplot2::scale_y_continuous(limits = c(0, 300)) +
  AirMonitorPlots::custom_aqiStackedBar(width = 0.01) 

```


Conclusion
