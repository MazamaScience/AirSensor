---
title: "MVCAA Tutorial 6: Methow Vallely Smoke"
author: "Mazama Science"
date: "2021-03-22"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MVCAA Tutorial 5: Building a Local Archive}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
```
left at line 78 -- WIP

## Introduction

_TO DO_

Tutorials in this series include:

* [MVCAA Tutorial 1: Creating PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_1.html)
* [MVCAA Tutorial 2: Exploring PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_2.html)
* [MVCAA Tutorial 3: Creating Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_3.html)
* [MVCAA Tutorial 4: Exploring Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_4.html)
* [MVCAA Tutorial 5: Building a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_5.html)
* [MVCAA Tutorial 6: Methow Vallely Smoke](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_6.html)

## Goal
_TO DO_

Outline:

Overarching question: How would you decide if sensors work?

Intro
* wildfire situation during fall 2020
* what about airquality? (transition to data)

Data and graphics 
```{r timeseries-fall, eval = TRUE, warning = FALSE, message = FALSE}
# Load the all-hourly-data-combined sensor object
all_sensors_fall <- 
  sensor_load(
    collection = "mvcaa", # collectionName defined by user 
    startdate = 20200901,
    enddate = 20201201,
    timezone = "America/Los_Angeles"
  )

# Plot all hourly values with daily averages
all_sensors_fall %>%
  AirMonitorPlots::ggplot_pm25Timeseries() + 
  ggplot2::ggtitle("Methow Valley -- September, 2020") +
  AirMonitorPlots::geom_pm25Points(shape = "square", alpha = .1) + 
  AirMonitorPlots::stat_dailyAQCategory(alpha = .5) + 
  ggplot2::scale_y_continuous(limits = c(0, 300)) +
  AirMonitorPlots::custom_aqiStackedBar(width = 0.01) 

```

```{r mvcca-minitors}
# find federal monitros in the Methow Valley for comparison with the sensors 
xlim <- c(-120.092,-120.284)
ylim <- c(48.313, 48.510)

mvcaa_monitors <- PWFSLSmoke::loadLatest() %>%
  monitor_subset(xlim = xlim, ylim = ylim)

mvcaa_monitors$meta$siteName # "Winthrop-Chewuch Rd" "Twisp-Ewell St"

mvcaa_monitors$meta$longitude
mvcaa_monitors$meta$latitude

# find sensors close to the monitors 
sensors <- pas_filterNear(pas = mvcaa, longitude = -120.1906, latitude = 48.47720, 
               radius = "5 km")
```
 

```{r timeseries-per-sensor}

# closer look at at the AQI of each location 
# Load AirMonitorPlots
library(AirMonitorPlots)

#--------------------------------- sep------------------------------------------
startdate = 20200901
enddate = 20201001

# Help ggplot out by assigning short labels to be used as the facet label
sep$meta$shortName <- 
  sep$meta$siteName %>%
  stringr::str_replace("MV Clean Air Ambassador @", "") %>%
  stringr::str_replace("MV Clean Air Ambassador-", "") %>%
  stringr::str_trim()

names(sep$meta)

# Fancy plot with AQI bars
gg <- 
  ggplot_pm25Timeseries(
    sep,
    startdate,
    enddate,
    timezone = "America/Los_Angeles"
  ) +
  ggtitle("Methow Valley PM2.5 values -- Sep, 2020") +
  stat_AQCategory(color = NA) + 
  facet_grid(rows = vars(shortName)) 

print(gg)

# most sensors have many days with missing data. 

# create airsensor object for sensors with little/no missing data 
sep_meta <- sep$meta #Gunn Ranch f736fd3fb21fc4da_13667, Pine Forest "0cbfeb2ce4c1553c_13661"
Gunn_Ranch <- "f736fd3fb21fc4da_13667"
Pine_Forest <- "0cbfeb2ce4c1553c_13661"


GR_09 <- pat_load(id = Gunn_Ranch,
           pas = mvcaa, 
           startdate = 20200901,
           enddate = 20201001, 
           timezone = "America/Los_Angeles") %>% 
  pat_createAirSensor(
    parameter = "pm25", 
    FUN = PurpleAirQC_hourly_AB_01)


PF_09 <- pat_load(id = Pine_Forest,
           pas = mvcaa, 
           startdate = 20200901,
           enddate = 20201001, 
           timezone = "America/Los_Angeles") %>% 
  pat_createAirSensor(
    parameter = "pm25", 
    FUN = PurpleAirQC_hourly_AB_01)

sensor_calendarPlot(
  sensor = PF_09,
  colors = "aqi",
  title = "September 2020 -- Pine Forest"
)

sensor_calendarPlot(
  sensor = GR_09,
  colors = "aqi",
  title = "September 2020 -- Gunn Ranch"
)

#--------------------------------- Oct -----------------------------------------
startdate = 20201001
enddate = 20201101

# Help ggplot out by assigning short labels to be used as the facet label
oct$meta$shortName <- 
  oct$meta$siteName %>%
  stringr::str_replace("MV Clean Air Ambassador @", "") %>%
  stringr::str_replace("MV Clean Air Ambassador-", "") %>%
  stringr::str_trim()

names(oct$meta)

# Fancy plot with AQI bars
gg <- 
  ggplot_pm25Timeseries(
    oct,
    startdate,
    enddate,
    timezone = "America/Los_Angeles"
  ) +
  ggtitle("Methow Valley PM2.5 values -- Oct, 2020") +
  stat_AQCategory(color = NA) + 
  facet_grid(rows = vars(shortName)) 

print(gg)
#impossible to see if data is missing due to resolution. 
#see if PF and GR have good data.

# create airsensor object for GR and PF during oct

GR_10 <- pat_load(id = Gunn_Ranch,
           pas = mvcaa, 
           startdate = 20201001,
           enddate = 20201101, 
           timezone = "America/Los_Angeles") %>% 
  pat_createAirSensor(
    parameter = "pm25", 
    FUN = PurpleAirQC_hourly_AB_01)


PF_10 <- pat_load(id = Pine_Forest,
           pas = mvcaa, 
           startdate = 20201001,
           enddate = 20201101, 
           timezone = "America/Los_Angeles") %>% 
  pat_createAirSensor(
    parameter = "pm25", 
    FUN = PurpleAirQC_hourly_AB_01)


sensor_calendarPlot(
  sensor = PF_10,
  colors = "aqi",
  title = "October 2020 -- Pine Forest"
)

sensor_calendarPlot(
  sensor = GR_10,
  colors = "aqi",
  title = "October 2020 -- Gunn Ranch"
)
 

#PF_10 AND GR_10 have data all days!

# random check of another sensor apparently with missing data from previous timeseries

cougar <- pat_load(
  id = "96b108298883ca47_64441",
  startdate = 20201001,
  enddate = 20201101,
  timezone = "America/Los_Angeles"
)

pat_dygraph(cougar) # the sensor does miss data. 

# How to tell a story if data is missing? use only sensors with "good data"?
```


WIP: code below needs editing 
```{r chronic-days}
# sites with worst chronic days 
fall_dailyAvg <- monitor_dailyStatistic(fall, FUN = mean, minHours = 20) # 20 or what number? 
data.daily <- fall_dailyAvg$data[,-1] # "-1" removes datetime column 
unhealthyDays <- apply(data.daily, 2, function(x) { sum(x >= AQI$breaks_24[4], na.rm = TRUE) }) #above 55.5, 2 = columns
worstChronic <- names(sort(unhealthyDays, decreasing = TRUE))[1:6]
fall$meta[worstChronic[1:3],"siteName"]

# WIP
# fire map 
# cold psrings fire coordinates 48.635 latitude, -119.818 longitude -- 6 Sept
# pearl hill fire coordinates 48.056 latitude, -119.484 longitude -- 7 Sept
airsensor_202009 # just an example of 2 airsensors 

fireLons <- c(-119.818, -119.484)
fireLats <- c(48.635, 48.056)
PWFSLSmoke::monitor_staticmap(
  airsensor_202009,
  slice = max,
  maptype = 'terrain',
  centerLon = mean(fireLons),
  centerLat = mean(fireLats),
  zoom = 7
)
PWFSLSmoke::addIcon('redFlame', fireLons, fireLats, expansion = .002)
PWFSLSmoke::addAQILegend(cex = 0.8, x = "bottomleft")
#title("September - October, 2020", line = -1.5, cex.main = 2)
layout(1)

```

```{r}
# dynamic map
monitor_leaflet( airsensor_202009, slice = max)
```

```{r}
# pollution rose plot
sensor_pollutionRose(
  sensor = pat2,
  statistic = "prop.mean"
)

```

```{r}
polar_plot <- sensor_polarPlot(
  sensor = pat2,
  statistic = "weighted_mean"
)
```



Conclusion
