---
title: "MVCAA Tutorial 2: Exploring PAT Data"
author: "Mazama Science"
date: "2021-03-02"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MVCAA Tutorial 2: Exploring PAT Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
knitr::opts_knit$set(root.dir = "C:/Users/astri/Mirror/Mazamascience/Projects/AirSensor")
```

## Introduction

This tutorial demonstrates basic exploration of previously created 'pat' 
timeseries data. In order to run the code in this tutoral you must have 
followed the instructions in Tutorial 1 and created a directory with 'pas' 
and 'pat' data files for the Methow Valley. Target
audiences include grad students, researchers and any member of the public
concerned about air quality and comfortable working with R and RStudio.

Tutorials in this series include:

* [MVCAA Tutorial 1: Creating PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_1.html)
* [MVCAA Tutorial 2: Examining PAT Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_2.html)
* [MVCAA Tutorial 3: Creating Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_3.html)
* [MVCAA Tutorial 4: Exploring Airsensor Data](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_4.html)
* [MVCAA Tutorial 5: Building a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_5.html)
* [MVCAA Tutorial 6: Using a Local Archive](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_6.html)
* [MVCAA Tutorial 7: Methow Vallely Smoke](https://mazamascience.github.io/AirSensor/articles/articles/MVCAA_Tutorial_7.html)

## Goal

Our goal in this tutorial is to explore a variety of `pat_~()` functions available
in the **AirSensor** package and to explain their most important arguments and 
the interpretation of output graphics.

## How to interpret the graphics
PurpleAir (PA) sensors are unique in that they have two separate optical particle 
detectors — one labeled A and one labeled B.
All of the plotting functions, except `pat_monitorComparison()` and 
`pat_externalFit()`, only use data from a *single* PA sensor — with A and B data channels. When measurements from the A and B channels are largely in agreement 
then the sensor is working properly. When they substantially differ, there is 
a problem. Moreover, when a sensor is properly functioning, correlation between 
the A and B channel (pm25_A:pm25_B) will be strongly positive, while correlation
between temperature and humidity will be strongly negative.

## Refresh from MVCAA Tutorial 1: Creating `pat` objects
```{r, eval=FALSE}
# Load files
patList <- get(load(paste0(archiveDir,"/patList.rda")))

# Print site names and associated ids
sapply(patList, function(x) { return(x$meta$label) }) 

# Pull out each sensor as a separate 'pat' object
Balky_Hill <- patList[["ab5dca99422f2c0d_13669"]]
Bush_School <- patList[["49215ad49d1a87e3_10188"]]
Liberty_School <- patList[["db5d6b3b79f5830e_39237"]]
McFarland_Creek <- patList[["f592adb5067ad9d3_13675"]]
Pine_Forest <- patList[["0cbfeb2ce4c1553c_13661"]]
Willowbrook_Farm <- patList[["f96deab8c29aa42b_10134"]]
Benson_Creek <- patList[["f6c44edd41c941c7_10182"]]
Gunn_Ranch <- patList[["f736fd3fb21fc4da_13667"]]
Lower_Studhorse <- patList[["4f19d256e1787973_10166"]]
Methow_Estates <- patList[["4a47b9252e16e558_15077"]] 
Beaver_Creek <- patList[["2e3b5ceea86a885b_10168"]]
Little_Cougar <- patList[["96b108298883ca47_64441"]]
```
# ! 
### Jon, I'm pretty sure there is a nice loop to pull out the sensors. I didn't have time to explore how to do it. 

## [pat_dygraph](https://mazamascience.github.io/AirSensor/reference/pat_dygraph.html)
This function creates interactive graphs that will be displayed in RStudio's 'Viewer' tab.

Lets explore a couple of sensors. 

### Balky Hill
```{r, Balky_Hill, eval=FALSE}
pat_dygraph(
  pat = Balky_Hill, 
  parameter = "pm25",
  sampleSize = 1000,
  title = NULL,
  xlab = "September 2020",
  ylab = NULL,
  tlim = NULL,
  rollPeriod = 6,
  showLegend = TRUE,
  colors = NULL,
  timezone = NULL
)

```


### Willowbrook Farm
```{r, Willowbrook_Farm, eval=FALSE }
pat_dygraph(
  pat = Willowbrook_Farm,       
  parameter = "pm25",
  sampleSize = 1000,
  title = NULL,
  xlab = "September 2020",
  ylab = NULL,
  tlim = NULL,
  rollPeriod = 6,
  showLegend = TRUE,
  colors = NULL,
  timezone = NULL)
```

Both graphs show missing data for one of the two channels on certain days.
For Balky Hill, measurements from the A and B channel are largely in agreement 
while for Willowbrook Farm, the channels are largely in disagreement. This could 
indicate a malfunctioning of the sensor, and it would be interesting to investigate
if this is an isolated event by exploring a larger time range. 

# ! 
### what are some causes of missing data? maintanance? sporadic malfunctioning of the sensor?


## pat_multiPlot() 

# ! 
### Jon, I can't link the function because the doc online doesn't work (error 404)

This function allow us to quickly display our raw `pat` data using the desired 
plottype. Available `plottype` options include:

* "all" – pm25_A, pm25_B, temperature, humidity

* "pm25_a" – PM2.5 from channel A only

* "pm25_b" – PM2.5 from channel B only

* "pm25" – PM2.5 from channels A and B in separate plots

* "pm25_over" – PM2.5 from channels A and B in the same plot

* "aux" – auxiliary data (temperature, humidity)

For the purpuse of this turorial we'll use "all", "pm25_over", and "aux".
```{r, pat_multiPlot - loop, eval=FALSE}
# create a test list of sensors to loop through 
test_list <- list(Balky_Hill, Bush_School, Liberty_School)

#tried loop but doesn't work
for (pat in test_list){
  pat_multiPlot(
    pat = pat,
    plottype = "all",
    sampleSize = 1000,
    columns = NULL,
    ylim = NULL,
    a_size = 1,
    a_shape = 15,
    a_color = rgb(0.9, 0.25, 0.2),
    b_size = 1,
    b_shape = 15,
    b_color = rgb(0.2, 0.25, 0.9),
    t_size = 1,
    t_shape = 15,
    t_color = "black",
    h_size = 1,
    h_shape = 15,
    h_color = "black",
    alpha = 0.5,
    timezone = NULL
  )
}

```

```{r, Balky_Hill all, eval=FALSE}
# Balky Hill multiplot - plottype = "all"
  pat_multiPlot(
    pat = Balky_Hill,
    plottype = "all",
    sampleSize = 1000,
    columns = NULL,
    ylim = NULL,
    a_size = 1,
    a_shape = 15,
    a_color = rgb(0.9, 0.25, 0.2),
    b_size = 1,
    b_shape = 15,
    b_color = rgb(0.2, 0.25, 0.9),
    t_size = 1,
    t_shape = 15,
    t_color = "black",
    h_size = 1,
    h_shape = 15,
    h_color = "black",
    alpha = 0.5,
    timezone = NULL
  )

```
The "all" plot type offers a nice overview of all four variables. We can 
already start seeing an agreement between channel A and B data and an inverse relationship between humidity and temperature measurments. 

Let's give a closer look to the channels using the "pm25_over" plot type. 
```{r, Balky_Hill pm25_over, eval=FALSE}
# Balky Hill multiplot - plottype = "pm25_over"
  pat_multiPlot(
    pat = Balky_Hill,
    plottype = "pm25_over",
    sampleSize = 1000,
    columns = NULL,
    ylim = NULL,
    a_size = 1,
    a_shape = 15,
    a_color = rgb(0.9, 0.25, 0.2),
    b_size = 1,
    b_shape = 15,
    b_color = rgb(0.2, 0.25, 0.9),
    t_size = 1,
    t_shape = 15,
    t_color = "black",
    h_size = 1,
    h_shape = 15,
    h_color = "black",
    alpha = 0.5,
    timezone = NULL
  )

```
Channels A and B show strong agreement, and we can strengthen our assumption by 
increasing the sample size. 

Let's try `sampleSize = 5000`. 
```{r, Balky_Hill pm25_over sampleSize 5000, eval=FALSE}
# Balky Hill multiplot - plottype = "pm25_over", sampleSize = 5000
  pat_multiPlot(
    pat = Balky_Hill,
    plottype = "pm25_over",
    sampleSize = 5000,
    columns = NULL,
    ylim = NULL,
    a_size = 1,
    a_shape = 15,
    a_color = rgb(0.9, 0.25, 0.2),
    b_size = 1,
    b_shape = 15,
    b_color = rgb(0.2, 0.25, 0.9),
    t_size = 1,
    t_shape = 15,
    t_color = "black",
    h_size = 1,
    h_shape = 15,
    h_color = "black",
    alpha = 0.5,
    timezone = NULL
  )

```
The trend looks consistent, channels A and B are largely in agreement. Purely 
based on visual interpreation, we could assume that the Bulky Hill sensor is 
working correctly. However, more in-depth statistical analysis is discussed later 
in this tutorial. 

Let's give a closer look to the relationship between temperature and humidity 
by using the "aux" plot type.
```{r, Balky_Hill aux, eval=FALSE}
# Balky Hill multiplot - plottype = "aux"
  pat_multiPlot(
    pat = Balky_Hill,
    plottype = "aux",
    sampleSize = 5000,
    columns = NULL,
    ylim = NULL,
    a_size = 1,
    a_shape = 15,
    a_color = rgb(0.9, 0.25, 0.2),
    b_size = 1,
    b_shape = 15,
    b_color = rgb(0.2, 0.25, 0.9),
    t_size = 1,
    t_shape = 15,
    t_color = "black",
    h_size = 1,
    h_shape = 15,
    h_color = "black",
    alpha = 0.5,
    timezone = NULL
  )

```
From the graph, we can start inferring a negative correlation between the two 
variables, which supports the assumption that the sensor is functioning correctly. 

## [pat_scatterPlotMatrix()](https://mazamascience.github.io/AirSensor/reference/pat_scatterPlotMatrix.html)

This function returns a matrix of scatterplots and correlation values for the 
"pm25_A", "pm25_B", "temperature", and "humidity" variable in the `pat` object. 

The list of available parameters include:

* datetime -- measurement time

* pm25_A -- A channel PM2.5 (ug/m3)

* pm25_B -- B channel PM2.5 (ug/m3)

* temperature -- temperature (F)

* humidity -- humidity (%)

Let's compare all of them for the Balky Hill sensor.  

```{r, pat_scatterPlotMatrix, eval=FALSE}
# Balky HIll scatterPlotMatrix
pat_scatterPlotMatrix(
  pat = Balky_Hill,
  parameters = c("datetime", "pm25_A", "pm25_B", "temperature", "humidity"),
  sampleSize = 5000,
  sampleFraction = NULL,
  size = 0.5,
  shape = 15,
  color = "black",
  alpha = 0.25
)
```

As we can see from the matrix, using a sample size of 5000 observations 
for each variable, we have a perfect positive correlation of 1 between 
channels A and B (pm25_A:pm25_B) and a strong negative correlation of -0.862 
between temperature and humidity. These results support the assumption that the 
sensor worked well throught September 2020. 

## [pat_outliers()](https://mazamascience.github.io/AirSensor/reference/pat_outliers.html)

# !
### this need some clarification. it seems that replace = TRUE does not replace 
### all outliers. Also, why I can't calculate the mean of the observations 
### (e.g. `mean(anysensor$data$pm25_A)` returns NA). I checked and the column 
### is numeric. 

```{r, pat_outliers, replace true, eval=FALSE}
# create an outliers plot for Willowbrook Farm 
Will_replace <- pat_outliers(
  pat = Willowbrook_Farm,
  windowSize = 15,
  thresholdMin = 8,
  replace = TRUE,
  showPlot = TRUE,
  data_shape = 18,
  data_size = 1,
  data_color = "black",
  data_alpha = 0.5,
  outlier_shape = 8,
  outlier_size = 1,
  outlier_color = "red",
  outlier_alpha = 1
)
```

```{r, pat_outliers, Will_replace, eval=FALSE}
# check if outliers were replaced with the median value 
pat_outliers(
  pat = Will_replace,
  windowSize = 15,
  thresholdMin = 8,
  replace = FALSE,
  showPlot = TRUE,
  data_shape = 18,
  data_size = 1,
  data_color = "black",
  data_alpha = 0.5,
  outlier_shape = 8,
  outlier_size = 1,
  outlier_color = "red",
  outlier_alpha = 1
)
# apparently not all outliers were replaced 
```

## [pat_internalFit()](https://mazamascience.github.io/AirSensor/reference/pat_internalFit.html)
This function uses a linear model to fit data from channel B to data from 
channel A. If you save the model into an object, you can then interrogate the 
linear model using the `base` function `summary()`. Set `showPlot = TRUE` if you
want to generate a utterly beautiful model fit plot.  

Let's have a look to a well fucntioning sensor and to a not-so-well functioning
one. 

```{r, lm_Balky, eval=FALSE}
# Balky Hill linear model 
lm_Balky <- pat_internalFit(
  pat = Balky_Hill,
  showPlot = TRUE,
  size = 1,
  a_color = "red",
  b_color = "blue",
  alpha = 0.25,
  lr_shape = 15,
  lr_color = "black",
  lr_lwd = 1.5,
  lr_lcolor = "tomato",
  lr_lalpha = 0.45,
  ts_shape = 1,
  xylim = NULL
)

summary(lm_Balky)
```
The model fit plot shows that the model is slightly biased towards channel A 
(slope = 1.05) and that the linear model explains 100% of the data variability,
supporting that the Balky Hill sensor's channels collected PM2.5 
measurments consistenly throughout September 2020.


```{r, lm_Willowbrook, eval=FALSE}
# Willowbrook Farm linear model
lm_Willowbrook <- pat_internalFit(
  pat = Willowbrook_Farm,
  showPlot = TRUE,
  size = 1,
  a_color = "red",
  b_color = "blue",
  alpha = 0.25,
  lr_shape = 15,
  lr_color = "black",
  lr_lwd = 1.5,
  lr_lcolor = "tomato",
  lr_lalpha = 0.45,
  ts_shape = 1,
  xylim = NULL
)

summary(lm_Willowbrook)
```
The model fit plot shows that the model is biased towards channel A 
(slope = 1.5), as evident in the bottom graphic, indicating the 
malfunctioning of one or both of the Willowbrook Farm sensor's channels 
throughout September 2020. 
Despite that, we observe that the model explains ~ 92% of the data variability 
(R2 = 0.922), suggesting that channel B is a reliable predictor of channel A's 
observations. We can explore further if `pm25_A` and 
`pm25_B` data are significantly different based on a student’s t-test. 

```{r, PurpleAirSoH_dailyABtTest() - Willowbrook_Farm, eval= FALSE}
tbl <- 
  Willowbrook_Farm %>%
  PurpleAirSoH_dailyABtTest()

timeseriesTbl_multiPlot(tbl)
timeseriesTbl_multiPlot(tbl_Balky)
hist(tbl$pm25_A_pm25_B_p_value)
sum(tbl$pm25_A_pm25_B_p_value < 0.05, na.rm = TRUE) #29 days of significant differences 

```

The plot is showing that the daily p-values were all below 0.05 (alpha value), 
and with a 95% confidence level we can state that the `pm25_A` and `pm25_B` data 
are significantly different. Thus, the September 2020 PM2.5 data collected by the
Willowbrook Farm sensor is not reliable.

#! 

### is this sctually true? What's the alpha value generally used? I did the same

### for an apperently well-functioning sensor (see code below), but that one too

### shows signififcantly different data for most of the month. Am I missing something?

### I think " hover near 0" should be substituted with an alpha value since we are 

### analyzing p-values. How can we reject or fail to reject the Null hypothesis 

### without alpha? (updated issue #261)

```{r, PurpleAirSoH_dailyABtTest() - Balky_Hill, eval= FALSE}
tbl_Balky <- 
  Balky_Hill %>%
  PurpleAirSoH_dailyABtTest()

timeseriesTbl_multiPlot(tbl_Balky)
hist(tbl_Balky$pm25_A_pm25_B_p_value)
sum(tbl_Balky$pm25_A_pm25_B_p_value < 0.05) #19 days of significant differences 
```
## [pat_dailySoHPlot()](https://mazamascience.github.io/AirSensor/reference/pat_dailySoHIndexPlot.html)
This function plots a subset of the most useful State of Health metrics calculated 
by the [pat_dailySoH()](https://mazamascience.github.io/AirSensor/reference/pat_dailySoH.html) 
function. The function runs pat_dailySoH internally and uses
the output to create the plot.
To better understand each plot, see also:

* [PurpleAirSoH_dailyPctDC()](https://mazamascience.github.io/AirSensor/reference/PurpleAirSoH_dailyPctDC.html)

* [PurpleAirSoH_dailyPctReporting()](https://mazamascience.github.io/AirSensor/reference/PurpleAirSoH_dailyPctReporting.html)

* [PurpleAirSoH_dailyPctValid()](https://mazamascience.github.io/AirSensor/reference/PurpleAirSoH_dailyPctValid.html)

* [PurpleAirSoH_dailyMetFit()](https://mazamascience.github.io/AirSensor/reference/PurpleAirSoH_dailyMetFit.html)

* [PurpleAirSoH_dailyABFit()](https://mazamascience.github.io/AirSensor/reference/PurpleAirSoH_dailyABFit.html)

* [PurpleAirSoH_dailyABtTest()](https://mazamascience.github.io/AirSensor/reference/PurpleAirSoH_dailyABtTest.html)

```{r, pat_dailySoHPlot() - Balky_Hill, eval= FALSE}
# create plots for Balky Hill sensor
pat_dailySoHPlot(Balky_Hill, ncol = 2)

# temporary notes to be removed in final tutorial.
# PurpleAirSoH_dailyPctDC()
# --> A high percent DC value indicates the likely occurrence of a “sticky value”, 
#     and a zero or low percent DC indicates that the sensor is recording dynamic data.
# PurpleAirSoH_dailyPctReporting()
# --> percentage of each day that the sensor is reporting data.
# PurpleAirSoH_dailyPctValid()
# --> percentage of the total recorded measurements that are considered plausible.
# PurpleAirSoH_dailyMetFit()
# --> This function calculates a daily linear model between the pm25_A, pm25_B, 
#     humidity, and temperature channels. values are expected to hover near 0 
#     for a properly functioning sensor.
# PurpleAirSoH_dailyABFit()
# --> daily linear model values between the pm25_A and pm25_B channels.
#     daily r-squared value is returned in addition to the coefficients of the 
#     linear fit (slope and intercept)
# PurpleAirSoH_dailyABtTest()
# --> This function calculates a t-test between the pm25_A, pm25_B.
#     All returned values are expected to hover near 0 for a properly 
#     functioning sensor.

```
The most concerning plot is pm25_A_temperature_rsquared given the persistent spikes 
throughout the month. Values are expected to hover near 0 for a properly 
functioning sensor. 
The pm25_A_pctDC and pm25_A_pctDC plots show that the channels A and B were 
recording dynamic data (value > 0) towards the beginning and the end of the month, 
which is also when the R squared values were lower. Especially at the beginning 
of the month, the pm25_A_pm25_B_rsquared plot shows R squared values hovering 
around zero, indicating a poor functioning of the sensor. 

#! 

### why pm25_B_temperature_rsquared is not included?

### what is DC?

## [pat_monitorComparison()](https://mazamascience.github.io/AirSensor/reference/pat_monitorComparison.html)
This function creates and returns a ggplot object that plots raw pat data, 
hourly aggregated pat data and hourly data from the nearest federal monitor 
from the [PWFSL database](https://haze.airfire.org/monitoring/).

```{r, pat_monitorComparison() - Balky_Hill, eval= FALSE}
# create comparison plot for balky Hill sensor
pat_monitorComparison(
  pat = Balky_Hill,
  FUN = AirSensor::PurpleAirQC_hourly_AB_01,
  distanceCutoff = 20,
  ylim = NULL,
  replaceOutliers = TRUE,
  timezone = NULL
)
# Error in monitor_subset(ws_monitor, tlim = c(starttime, endtime)) : ws_monitor 
# object contains zero monitors

?pat_monitorComparison
# try example to see if it works 
pat_monitorComparison(example_pat) # OK
example_pat <- example_pat$data

# try Willowbrook_Farm
pat_monitorComparison(
  pat = Willowbrook_Farm,
  FUN = AirSensor::PurpleAirQC_hourly_AB_01,
  distanceCutoff = 20,
  ylim = NULL,
  replaceOutliers = TRUE,
  timezone = NULL
)
# Error in monitor_subset(ws_monitor, tlim = c(starttime, endtime)) : ws_monitor 
# object contains zero monitors

```

# !  

### Could you explain the error? I see that the closest PWFSL monitor is 840530470016_01
 

## [pat_externalFit()](https://mazamascience.github.io/AirSensor/reference/pat_externalFit.html)
This function produces a linear model between data from PurpleAir and data from 
the closest PWFSL monitor. A diagnostic plot is produced if `showPlot = TRUE`.

```{r, pat_externalFit - Balky_Hill, eval= FALSE}
# create comparison plot for balky Hill sensor
pat_externalFit(
  pat = Balky_Hill,
  showPlot = TRUE,
  size = 1,
  pa_color = "purple",
  pwfsl_color = "black",
  alpha = 0.5,
  lr_shape = 15,
  lr_color = "black",
  lr_lwd = 1.5,
  lr_lcolor = "tomato",
  lr_lalpha = 0.45,
  ts_shape = 1,
  xylim = NULL,
  channel = "ab",
  replaceOutliers = TRUE,
  qc_algorithm = "hourly_AB_01",
  min_count = 20
)

# Error in monitor_subset(ws_monitor, tlim = c(starttime, endtime)) : ws_monitor 
# object contains zero monitors

```
# ! 

### Could you explain the error? I see that the closest PWFSL monitor is 840530470016_01
----

_Best of luck assessing air quality in your community!_
